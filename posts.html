<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Posts - VerifyID Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <!-- Configuration -->
    <script src="config.js"></script>
    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>
    <!-- Midnight Network Integration -->
    <script src="midnight-integration.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'gradient-start': '#1a0b2e',
                        'gradient-mid': '#2d1b4e',
                        'gradient-end': '#4a1942',
                        'accent-pink': '#ff6b9d',
                        'accent-red': '#ff4757'
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1a0b2e 0%, #2d1b4e 50%, #4a1942 100%);
        }
        .text-gradient {
            background: linear-gradient(135deg, #ff6b9d 0%, #ff4757 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .btn-gradient {
            background: linear-gradient(135deg, #ff6b9d 0%, #ff4757 100%);
        }
        .card-gradient {
            background: linear-gradient(135deg, rgba(255, 107, 157, 0.1) 0%, rgba(255, 71, 87, 0.1) 100%);
            border: 1px solid rgba(255, 107, 157, 0.2);
        }
        .post-card {
            background: linear-gradient(135deg, rgba(255, 107, 157, 0.05) 0%, rgba(255, 71, 87, 0.05) 100%);
            border: 1px solid rgba(255, 107, 157, 0.1);
        }
        .verified-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <!-- Navigation -->
    <nav class="fixed top-0 w-full z-50 bg-black bg-opacity-30 backdrop-blur-md border-b border-pink-500 border-opacity-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gradient">VerifyID</h1>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="index.html" class="text-pink-200 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition-colors">Home</a>
                        <a href="verify.html" class="text-pink-200 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition-colors">Verify ID</a>
                        <a href="posts.html" class="text-white bg-pink-500 bg-opacity-20 px-3 py-2 rounded-md text-sm font-medium">Community</a>
                    </div>
                </div>
                <div class="md:hidden">
                    <button id="mobile-menu-btn" class="text-pink-200 hover:text-white">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        <div id="mobile-menu" class="md:hidden hidden bg-black bg-opacity-50">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <a href="index.html" class="text-pink-200 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Home</a>
                <a href="verify.html" class="text-pink-200 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Verify ID</a>
                <a href="posts.html" class="text-white bg-pink-500 bg-opacity-20 block px-3 py-2 rounded-md text-base font-medium">Community</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-16">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <!-- Header -->
            <div class="text-center mb-12">
                <h1 class="text-3xl md:text-4xl font-bold text-gradient mb-4">Community Posts</h1>
                <p class="text-xl text-pink-200">Share your thoughts with verified professionals and students</p>
            </div>

            <!-- Verification Status -->
            <div id="verification-status" class="mb-8">
                <!-- Not Verified -->
                <div id="not-verified" class="card-gradient rounded-xl p-6 text-center">
                    <div class="w-16 h-16 bg-yellow-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-yellow-400 mb-2">Verification Required</h3>
                    <p class="text-pink-200 mb-4">You need to verify your identity before posting in the community</p>
                    <a href="verify.html" class="btn-gradient text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90 transition-opacity inline-block">
                        Verify Your ID
                    </a>
                </div>

                <!-- Verified -->
                <div id="verified" class="hidden card-gradient rounded-xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 id="user-name" class="text-lg font-bold text-green-400">Verified User</h3>
                                <p id="user-badge" class="text-pink-200 text-sm">Verification pending...</p>
                            </div>
                        </div>
                        <button id="new-post-btn" class="btn-gradient text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition-opacity">
                            New Post
                        </button>
                    </div>
                </div>
            </div>

            <!-- New Post Form -->
            <div id="new-post-form" class="hidden card-gradient rounded-xl p-6 mb-8">
                <h3 class="text-xl font-bold text-gradient mb-4">Create New Post</h3>
                
                <!-- Avatar Upload -->
                <div class="mb-4">
                    <label class="block text-pink-200 text-sm font-medium mb-2">Avatar (Optional)</label>
                    <div class="flex items-center space-x-4">
                        <div id="avatar-preview" class="w-12 h-12 bg-gray-600 rounded-full flex items-center justify-center overflow-hidden">
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <input type="file" id="avatar-input" accept="image/*" class="hidden">
                        <button id="avatar-btn" class="text-pink-300 hover:text-white transition-colors text-sm">
                            Choose Avatar
                        </button>
                        <button id="remove-avatar" class="hidden text-red-400 hover:text-red-300 transition-colors text-sm">
                            Remove
                        </button>
                    </div>
                </div>

                <!-- Post Content -->
                <div class="mb-4">
                    <label for="post-content" class="block text-pink-200 text-sm font-medium mb-2">Your Message</label>
                    <textarea id="post-content" rows="4" class="w-full bg-black bg-opacity-30 border border-pink-500 border-opacity-30 rounded-lg px-4 py-3 text-white placeholder-pink-300 focus:outline-none focus:border-pink-500 resize-none" placeholder="Share your thoughts with the community..."></textarea>
                    <div class="flex justify-between items-center mt-2">
                        <span id="char-count" class="text-pink-300 text-sm">0/500</span>
                        <span id="content-warning" class="text-red-400 text-sm hidden">Content may contain inappropriate language</span>
                    </div>
                </div>

                <!-- Post Actions -->
                <div class="flex justify-end space-x-3">
                    <button id="cancel-post" class="text-pink-300 hover:text-white px-4 py-2 rounded-lg transition-colors">
                        Cancel
                    </button>
                    <button id="submit-post" class="btn-gradient text-white px-6 py-2 rounded-lg font-semibold hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Post
                    </button>
                </div>
            </div>

            <!-- Posts Feed -->
            <div id="posts-feed">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gradient">Recent Posts</h2>
                    <select id="sort-posts" class="bg-black bg-opacity-30 border border-pink-500 border-opacity-30 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-pink-500">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                    </select>
                </div>

                <!-- Posts Container -->
                <div id="posts-container" class="space-y-6">
                    <!-- Sample posts will be loaded here -->
                </div>

                <!-- Empty State -->
                <div id="empty-posts" class="hidden text-center py-12">
                    <div class="w-16 h-16 bg-gray-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-400 mb-2">No posts yet</h3>
                    <p class="text-pink-200">Be the first to share something with the community!</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Enhanced profanity filter
        const profanityWords = [
            'damn', 'hell', 'stupid', 'idiot', 'hate', 'suck', 'crap', 'shit', 'fuck', 
            'bitch', 'ass', 'bastard', 'piss', 'dumb', 'moron', 'retard', 'gay', 
            'fag', 'slut', 'whore', 'nigger', 'chink', 'spic', 'kike'
        ];

        let posts = [];
        let currentUser = null;
        let currentAvatar = null;
        let firebaseInitialized = false;

        // Load verification data from localStorage (45 min session)
        function loadUserVerificationData() {
            try {
                const verificationData = localStorage.getItem('anonshare_verification_data');
                if (verificationData) {
                    const data = JSON.parse(verificationData);
                    
                    // Check if verification expired
                    if (Date.now() > data.expiresAt) {
                        localStorage.removeItem('anonshare_verification_data');
                        document.getElementById('user-name').textContent = 'Verified User';
                        document.getElementById('user-badge').textContent = 'Verification expired - please verify again';
                        return;
                    }
                    
                    // Update user display with real data
                    const userName = document.getElementById('user-name');
                    const userBadge = document.getElementById('user-badge');
                    
                    userName.textContent = `Verified User`;
                    userBadge.textContent = `Verified ${data.role} at ${data.organization}`;
                    
                    if (data.verificationScore) {
                        userBadge.textContent += ` • Score: ${data.verificationScore}/10`;
                    }
                    
                    // Show remaining time
                    const timeLeft = Math.max(0, Math.floor((data.expiresAt - Date.now()) / (1000 * 60)));
                    userBadge.textContent += ` • ${timeLeft} min left`;
                } else {
                    document.getElementById('user-name').textContent = 'Verified User';
                    document.getElementById('user-badge').textContent = 'Please verify your identity to post';
                }
            } catch (error) {
                console.error('Error loading verification data:', error);
                document.getElementById('user-name').textContent = 'Verified User';
                document.getElementById('user-badge').textContent = 'Verification error';
            }
        }

        // Profanity filter
        function filterProfanity(text) {
            let filtered = text;
            profanityWords.forEach(word => {
                const regex = new RegExp(word, 'gi');
                filtered = filtered.replace(regex, '*'.repeat(word.length));
            });
            return filtered;
        }

        // Check if user is verified
        function isUserVerified() {
            const verificationData = localStorage.getItem('anonshare_verification_data');
            if (!verificationData) return false;
            
            const data = JSON.parse(verificationData);
            return Date.now() <= data.expiresAt;
        }

        // Get user verification data
        function getUserData() {
            const verificationData = localStorage.getItem('anonshare_verification_data');
            if (!verificationData) return null;
            
            const data = JSON.parse(verificationData);
            if (Date.now() > data.expiresAt) return null;
            
            return data;
        }

        // Initialize page with Midnight integration
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize Firebase for posts only
            firebaseInitialized = initializeFirebase();
            
            // Load verification data from localStorage
            loadUserVerificationData();
            
            // Load posts from Firebase
            posts = await StorageManager.loadPosts();
            
            // Initialize Midnight Network
            try {
                await midnight.initialize();
                console.log('Midnight Network initialized for posts');
            } catch (error) {
                console.error('Failed to initialize Midnight:', error);
            }
            
            checkVerificationStatus();
            await loadPosts();
            setupEventListeners();
        });

        // Load posts from Midnight Network and Firebase
        async function loadPosts() {
            try {
                // Try to load from Midnight Network first
                const midnightPosts = await midnight.getPosts(0, 20);
                
                // Load from Firebase/localStorage as backup
                const localPosts = await StorageManager.loadPosts();
                
                // Combine and deduplicate posts
                const allPosts = [...midnightPosts, ...localPosts];
                posts = deduplicatePosts(allPosts);
                
                // Add sample posts if no posts exist
                if (posts.length === 0) {
                    posts = [
                        {
                            id: 1,
                            author: "Verified User",
                            organization: "University",
                            role: "Student/Academic",
                            content: "Excited to be part of this privacy-first community powered by Midnight Network! Zero-knowledge proofs are the future.",
                            timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
                            avatar: null,
                            orgType: 1,
                            roleType: 1,
                            likes: 5,
                            likedBy: ['user1', 'user2', 'user3', 'user4', 'user5'],
                            replies: [
                                {
                                    content: "Totally agree! Privacy is so important.",
                                    author: "Verified User",
                                    timestamp: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString()
                                }
                            ]
                        },
                        {
                            id: 2,
                            author: "Verified User",
                            organization: "Company",
                            role: "Employee/Professional",
                            content: "Working on privacy-preserving applications. The Midnight Network makes it so easy to build with ZK proofs!",
                            timestamp: new Date(Date.now() - 5 * 60 * 60 * 1000).toISOString(),
                            avatar: null,
                            orgType: 2,
                            roleType: 2,
                            likes: 3,
                            likedBy: ['user6', 'user7', 'user8'],
                            replies: []
                        }
                    ];
                }
                
                displayPosts();
            } catch (error) {
                console.error('Failed to load posts:', error);
                showNotification('Failed to load posts', 'error');
            }
        }

        // Deduplicate posts by ID
        function deduplicatePosts(allPosts) {
            const seen = new Set();
            return allPosts.filter(post => {
                if (seen.has(post.id)) {
                    return false;
                }
                seen.add(post.id);
                return true;
            });
        }

        // Submit post with Midnight Network integration
        async function submitPost() {
            const content = document.getElementById('post-content').value.trim();
            
            if (!content || !currentUser) return;
            
            try {
                // Generate user secret for rate limiting and reputation
                const userSecret = await generateUserSecret();
                
                // Check rate limiting with nullifiers
                const epoch = Math.floor(Date.now() / (1000 * 60 * 60)); // 1-hour epochs
                await midnight.generateRateLimitNullifier(userSecret, epoch);
                
                // Submit to Midnight Network first
                const midnightResult = await midnight.submitPost(content);
                console.log('Post submitted to Midnight Network:', midnightResult);
                
                const newPost = {
                    id: Date.now(),
                    author: 'Verified User', // Privacy-first: no real names
                    organization: currentUser.organization,
                    role: currentUser.role,
                    content: content,
                    timestamp: new Date().toISOString(),
                    avatar: currentAvatar,
                    verificationScore: currentUser.score || 0,
                    orgType: currentUser.orgType || 1,
                    roleType: currentUser.roleType || 1,
                    zkProof: currentUser.zkProof || null,
                    score: Math.floor(Math.random() * 3) + 8, // 8-10 score for demo
                    midnightTx: midnightResult.txHash
                };
                
                // Save to Firebase/localStorage as backup
                await StorageManager.savePost(newPost);
                
                // Add to local array and refresh display
                posts.unshift(newPost);
                
                // Update anonymous reputation
                await updateAnonymousReputation(userSecret);
                
                displayPosts();
                hideNewPostForm();
                
                showNotification('Post published with ZK proof and rate limiting!', 'success');
                
            } catch (error) {
                if (error.message.includes('Rate limit exceeded')) {
                    showNotification('Rate limit: 5 posts per hour maximum. Please wait before posting again.', 'error');
                } else {
                    console.error('Failed to submit post:', error);
                    showNotification('Failed to publish post', 'error');
                }
            }
        }

        async function generateUserSecret() {
            // Generate consistent user secret for rate limiting and reputation
            let userSecret = localStorage.getItem('anonshare_user_secret');
            if (!userSecret) {
                const crypto = window.crypto || window.msCrypto;
                const array = new Uint8Array(32);
                crypto.getRandomValues(array);
                userSecret = Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
                localStorage.setItem('anonshare_user_secret', userSecret);
            }
            return userSecret;
        }

        async function updateAnonymousReputation(userSecret) {
            try {
                // Get user's posts for reputation calculation
                const userPosts = posts.filter(post => post.organization === currentUser.organization);
                
                if (userPosts.length > 0) {
                    const reputation = await midnight.buildAnonymousReputation(userPosts, userSecret);
                    console.log('🏆 Anonymous reputation updated:', reputation);
                    
                    // Show reputation indicator
                    showReputationIndicator(reputation);
                }
            } catch (error) {
                console.error('Failed to update reputation:', error);
            }
        }

        function showReputationIndicator(reputation) {
            const indicator = document.createElement('div');
            indicator.className = 'fixed top-20 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            indicator.innerHTML = `
                <div class="flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                    </svg>
                    <span>Reputation: ${reputation.reputation.avgScore.toFixed(1)}/10 (Anonymous)</span>
                </div>
            `;
            
            document.body.appendChild(indicator);
            setTimeout(() => indicator.remove(), 5000);
        }

        // Enhanced content filtering
        function handleContentChange(e) {
            const content = e.target.value;
            const charCount = content.length;
            
            // Update character count
            document.getElementById('char-count').textContent = `${charCount}/500`;
            
            // Enhanced profanity check
            const hasProfanity = profanityWords.some(word => {
                const regex = new RegExp(`\\b${word}\\b`, 'gi');
                return regex.test(content);
            });
            
            // Check for spam patterns
            const hasSpam = checkSpamPatterns(content);
            
            const warningElement = document.getElementById('content-warning');
            if (hasProfanity || hasSpam) {
                warningElement.textContent = hasProfanity ? 
                    'Content may contain inappropriate language' : 
                    'Content may be spam';
                warningElement.classList.remove('hidden');
            } else {
                warningElement.classList.add('hidden');
            }
            
            // Enable/disable submit button
            const submitBtn = document.getElementById('submit-post');
            submitBtn.disabled = charCount === 0 || charCount > 500 || hasProfanity || hasSpam;
        }

        // Check for spam patterns
        function checkSpamPatterns(content) {
            const spamPatterns = [
                /(.)\1{4,}/g, // Repeated characters (aaaaa)
                /\b(click here|buy now|free money|make money|earn \$|viagra|casino)\b/gi,
                /[A-Z]{10,}/g, // Too many caps
                /(.{1,10})\1{3,}/g // Repeated phrases
            ];
            
            return spamPatterns.some(pattern => pattern.test(content));
        }

        // Display posts
        function displayPosts() {
            const container = document.getElementById('posts-container');
            const emptyState = document.getElementById('empty-posts');
            
            if (posts.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            container.innerHTML = posts.map(post => createPostHTML(post)).join('');
        }

        // Mobile menu toggle
        document.getElementById('mobile-menu-btn').addEventListener('click', function() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        });

        function setupEventListeners() {
            // New post button
            document.getElementById('new-post-btn').addEventListener('click', showNewPostForm);
            
            // Cancel post
            document.getElementById('cancel-post').addEventListener('click', hideNewPostForm);
            
            // Avatar upload
            document.getElementById('avatar-btn').addEventListener('click', () => {
                document.getElementById('avatar-input').click();
            });
            
            document.getElementById('avatar-input').addEventListener('change', handleAvatarUpload);
            document.getElementById('remove-avatar').addEventListener('click', removeAvatar);
            
            // Post content
            document.getElementById('post-content').addEventListener('input', handleContentChange);
            
            // Submit post
            document.getElementById('submit-post').addEventListener('click', submitPost);
            
            // Sort posts
            document.getElementById('sort-posts').addEventListener('change', function() {
                const sortBy = this.value;
                if (sortBy === 'newest') {
                    posts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                } else if (sortBy === 'oldest') {
                    posts.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                } else if (sortBy === 'score') {
                    posts.sort((a, b) => (b.score || 0) - (a.score || 0));
                }
                displayPosts();
            });
        }

        function checkVerificationStatus() {
            const verificationData = localStorage.getItem('verificationData');
            
            if (verificationData) {
                const data = JSON.parse(verificationData);
                const now = Date.now();
                const verificationTime = data.timestamp ? new Date(data.timestamp).getTime() : 0;
                const sixtyMinutes = 60 * 60 * 1000; // 60 minutes in milliseconds
                
                // Check if verification is still valid (within 60 minutes)
                if (data.verified && (now - verificationTime < sixtyMinutes)) {
                    currentUser = data;
                    showVerifiedStatus(data);
                    
                    // Show time remaining
                    const timeLeft = Math.ceil((sixtyMinutes - (now - verificationTime)) / (60 * 1000));
                    console.log(`Verification valid for ${timeLeft} more minutes`);
                    return;
                } else if (data.verified) {
                    // Verification expired
                    localStorage.removeItem('verificationData');
                    console.log('Verification expired after 60 minutes');
                }
            }
            
            showNotVerifiedStatus();
        }

        function showVerifiedStatus(data) {
            document.getElementById('not-verified').style.display = 'none';
            document.getElementById('verified').classList.remove('hidden');
            
            // Format the badge text properly
            let badgeText;
            if (data.organization === 'India') {
                badgeText = `Verified ${data.role} of ${data.organization}`;
            } else {
                badgeText = `Verified ${data.role} at ${data.organization}`;
            }
            
            document.getElementById('user-badge').textContent = badgeText;
            
            // Show verification timer
            updateVerificationTimer(data.timestamp);
            
            // Update timer every minute
            if (window.verificationTimer) clearInterval(window.verificationTimer);
            window.verificationTimer = setInterval(() => {
                updateVerificationTimer(data.timestamp);
            }, 60000); // Update every minute
        }
        
        function updateVerificationTimer(timestamp) {
            const now = Date.now();
            const verificationTime = new Date(timestamp).getTime();
            const sixtyMinutes = 60 * 60 * 1000;
            const timeLeft = Math.ceil((sixtyMinutes - (now - verificationTime)) / (60 * 1000));
            
            if (timeLeft > 0) {
                const timerElement = document.getElementById('verification-timer');
                if (!timerElement) {
                    // Create timer element
                    const timer = document.createElement('div');
                    timer.id = 'verification-timer';
                    timer.className = 'text-xs text-pink-300 mt-1';
                    document.getElementById('user-badge').parentNode.appendChild(timer);
                }
                document.getElementById('verification-timer').textContent = `Expires in ${timeLeft} minutes`;
            } else {
                // Verification expired, refresh page
                localStorage.removeItem('verificationData');
                location.reload();
            }
        }

        function showNotVerifiedStatus() {
            document.getElementById('verified').classList.add('hidden');
            document.getElementById('not-verified').style.display = 'block';
        }

        function showNewPostForm() {
            document.getElementById('new-post-form').classList.remove('hidden');
            document.getElementById('post-content').focus();
        }

        function hideNewPostForm() {
            document.getElementById('new-post-form').classList.add('hidden');
            document.getElementById('post-content').value = '';
            document.getElementById('char-count').textContent = '0/500';
            
            // Reset submit button
            const submitBtn = document.getElementById('submit-post');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Post';
            
            removeAvatar();
        }

        function handleAvatarUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentAvatar = e.target.result;
                    const preview = document.getElementById('avatar-preview');
                    preview.innerHTML = `<img src="${currentAvatar}" class="w-full h-full object-cover rounded-full">`;
                    document.getElementById('remove-avatar').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function removeAvatar() {
            currentAvatar = null;
            document.getElementById('avatar-input').value = '';
            document.getElementById('avatar-preview').innerHTML = `
                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7-7h14a7 7 0 00-7-7z"></path>
                </svg>
            `;
            document.getElementById('remove-avatar').classList.add('hidden');
        }

        function handleContentChange(e) {
            const content = e.target.value;
            const charCount = content.length;
            
            // Update character count
            document.getElementById('char-count').textContent = `${charCount}/500`;
            
            // Check for profanity (whole words only)
            const hasProfanity = profanityWords.some(word => {
                const regex = new RegExp(`\\b${word}\\b`, 'gi');
                return regex.test(content);
            });
            
            const warningElement = document.getElementById('content-warning');
            if (hasProfanity) {
                warningElement.classList.remove('hidden');
            } else {
                warningElement.classList.add('hidden');
            }
            
            // Enable/disable submit button
            const submitBtn = document.getElementById('submit-post');
            submitBtn.disabled = charCount === 0 || charCount > 500 || hasProfanity;
        }

        async function submitPost() {
            const content = document.getElementById('post-content').value.trim();
            
            if (!content) return;
            
            // Check for profanity
            const hasProfanity = profanityWords.some(word => {
                return content.toLowerCase().includes(word.toLowerCase());
            });
            
            if (hasProfanity) {
                showProfanityWarning();
                return;
            }
            
            // Check if user is verified
            if (!isUserVerified()) {
                alert('Please verify your identity first to post');
                return;
            }
            
            const userData = getUserData();
            if (!userData) return;
            
            // Disable submit button
            const submitBtn = document.getElementById('submit-post');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Posting...';
            
            try {
                // Apply profanity filter
                const filteredContent = filterProfanity(content);
                
                const newPost = {
                    content: filteredContent,
                    role: userData.role,
                    organization: userData.organization,
                    avatar: currentAvatar,
                    timestamp: Date.now(),
                    likes: 0,
                    likedBy: [],
                    replies: []
                };
                
                // Save to Firebase
                if (db) {
                    const docRef = await db.collection('posts').add(newPost);
                    newPost.id = docRef.id;
                    console.log('Post saved to Firebase:', docRef.id);
                } else {
                    newPost.id = Date.now().toString();
                }
                
                // Add to local posts array
                posts.unshift(newPost);
                renderPosts();
                
                // Clear form
                document.getElementById('post-content').value = '';
                document.getElementById('char-count').textContent = '0';
                
                // Hide form
                hideNewPostForm();
                showNotification('Post published successfully!', 'success');
                
            } catch (error) {
                console.error('Error creating post:', error);
                alert('Error creating post. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Post';
            }
        }

        function renderPosts() {
            const postsContainer = document.getElementById('posts-container');
            if (posts.length === 0) {
                document.getElementById('empty-posts').classList.remove('hidden');
                postsContainer.innerHTML = '';
                return;
            }
            
            document.getElementById('empty-posts').classList.add('hidden');
            postsContainer.innerHTML = posts.map(post => createPostHTML(post)).join('');
        }

        function createPostHTML(post) {
            // Handle timestamp properly
            let timestamp = post.timestamp;
            if (timestamp && timestamp.seconds) {
                // Firebase timestamp
                timestamp = new Date(timestamp.seconds * 1000);
            } else if (timestamp) {
                // ISO string
                timestamp = new Date(timestamp);
            } else {
                // Fallback
                timestamp = new Date();
            }
            
            const timeAgo = getTimeAgo(timestamp);
            const avatarHTML = post.avatar 
                ? `<img src="${post.avatar}" class="w-full h-full object-cover rounded-full">`
                : `<svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7-7h14a7 7 0 00-7-7z"></path>
                   </svg>`;
            
            return `
                <div class="post-card rounded-xl p-6" data-post-id="${post.id}">
                    <div class="flex items-start space-x-4">
                        <div class="w-12 h-12 bg-gray-600 rounded-full flex items-center justify-center overflow-hidden flex-shrink-0">
                            ${avatarHTML}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center space-x-2 mb-2">
                                <h3 class="font-semibold text-white">${post.author}</h3>
                                <span class="verified-badge text-white text-xs px-2 py-1 rounded-full">
                                    ✓ Verified ${post.role || 'User'} at ${post.organization}
                                </span>
                            </div>
                            ${post.content ? `<p class="text-pink-200 mb-3 leading-relaxed">${post.content}</p>` : ''}
                            
                            <!-- Like and Reply Actions -->
                            <div class="flex items-center justify-between text-sm text-pink-300 mb-3">
                                <span>${timeAgo}</span>
                                <div class="flex items-center space-x-4">
                                    <button onclick="toggleLike('${post.id}')" class="flex items-center space-x-1 hover:text-pink-400 transition-colors">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                        </svg>
                                        <span id="like-count-${post.id}">${post.likes || 0}</span>
                                    </button>
                                    <button onclick="toggleReply('${post.id}')" class="flex items-center space-x-1 hover:text-pink-400 transition-colors">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                        </svg>
                                        <span>Reply</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Reply Form (Hidden by default) -->
                            <div id="reply-form-${post.id}" class="hidden mt-3 p-3 bg-gray-800 bg-opacity-50 rounded-lg">
                                <textarea id="reply-text-${post.id}" placeholder="Write a reply..." class="w-full bg-gray-700 text-white p-2 rounded resize-none" rows="2"></textarea>
                                <div class="flex justify-end mt-2 space-x-2">
                                    <button onclick="cancelReply('${post.id}')" class="px-3 py-1 text-gray-400 hover:text-white">Cancel</button>
                                    <button onclick="submitReply('${post.id}')" class="px-3 py-1 bg-pink-600 text-white rounded hover:bg-pink-700">Reply</button>
                                </div>
                            </div>
                            
                            <!-- Replies -->
                            <div id="replies-${post.id}" class="mt-3 space-y-2">
                                ${(post.replies || []).map(reply => `
                                    <div class="bg-gray-800 bg-opacity-30 p-3 rounded-lg ml-4">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <span class="font-semibold text-white text-sm">Verified User</span>
                                            <span class="text-xs text-gray-400">${getTimeAgo(new Date(reply.timestamp))}</span>
                                        </div>
                                        <p class="text-pink-200 text-sm">${reply.content}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Like and Reply Functions
        async function toggleLike(postId) {
            if (!currentUser) {
                showNotification('Please verify your ID first', 'error');
                return;
            }
            
            const post = posts.find(p => p.id === postId);
            if (!post) return;
            
            const userId = currentUser.id || 'anonymous';
            if (!post.likedBy) post.likedBy = [];
            
            const hasLiked = post.likedBy.includes(userId);
            
            if (hasLiked) {
                // Unlike
                post.likes = Math.max(0, (post.likes || 0) - 1);
                post.likedBy = post.likedBy.filter(id => id !== userId);
            } else {
                // Like
                post.likes = (post.likes || 0) + 1;
                post.likedBy.push(userId);
            }
            
            // Update UI
            const likeCount = document.getElementById(`like-count-${postId}`);
            if (likeCount) {
                likeCount.textContent = post.likes;
            }
            
            // Save to Firebase
            await StorageManager.likePost(postId, userId);
        }

        function toggleReply(postId) {
            if (!currentUser) {
                showNotification('Please verify your ID first', 'error');
                return;
            }
            
            const replyForm = document.getElementById(`reply-form-${postId}`);
            if (replyForm) {
                replyForm.classList.toggle('hidden');
                if (!replyForm.classList.contains('hidden')) {
                    document.getElementById(`reply-text-${postId}`).focus();
                }
            }
        }

        function cancelReply(postId) {
            const replyForm = document.getElementById(`reply-form-${postId}`);
            const replyText = document.getElementById(`reply-text-${postId}`);
            if (replyForm && replyText) {
                replyForm.classList.add('hidden');
                replyText.value = '';
            }
        }

        async function submitReply(postId) {
            if (!currentUser) {
                showNotification('Please verify your ID first', 'error');
                return;
            }
            
            const replyText = document.getElementById(`reply-text-${postId}`);
            if (!replyText || !replyText.value.trim()) {
                showNotification('Please enter a reply', 'error');
                return;
            }
            
            const content = replyText.value.trim();
            
            // Check for profanity
            const hasProfanity = profanityWords.some(word => {
                return content.toLowerCase().includes(word.toLowerCase());
            });
            
            if (hasProfanity) {
                showProfanityWarning();
                return;
            }
            
            const reply = {
                content: content,
                author: 'Verified User',
                timestamp: new Date().toISOString()
            };
            
            // Add to local post
            const post = posts.find(p => p.id === postId);
            if (post) {
                if (!post.replies) post.replies = [];
                post.replies.push(reply);
                
                // Save to Firebase
                await StorageManager.addReply(postId, reply);
                
                // Update UI
                renderPosts();
                showNotification('Reply added!', 'success');
            }
        }

        function showProfanityWarning() {
            const warning = document.createElement('div');
            warning.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            warning.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-lg max-w-md mx-4">
                    <div class="flex items-center mb-4">
                        <svg class="w-6 h-6 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        <h3 class="text-lg font-semibold text-white">Content Warning</h3>
                    </div>
                    <p class="text-pink-200 mb-4">Your message contains inappropriate language. Please revise your content to maintain a respectful community environment.</p>
                    <div class="flex justify-end">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-pink-600 text-white rounded hover:bg-pink-700">
                            OK
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(warning);
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            return `${Math.floor(diffInSeconds / 86400)}d ago`;
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-20 right-4 z-50 px-6 py-3 rounded-lg text-white font-semibold ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html>
